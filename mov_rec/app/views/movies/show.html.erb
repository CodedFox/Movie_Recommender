<p id="notice"><%= notice %></p>

<img src="<%= @movie.poster %>" style="width: 350px; float: right">

<h2><%= @movie.movie_name %></h2>

<p>
  <strong>Description:</strong>
  <%= @movie.description %>
</p>

<p>
  <strong>Date released:</strong>
  <%= @movie.date_released %>
</p>

<p>
  <strong>Duration:</strong>
  <%= @movie.duration %>
</p>

<p>
  <strong>Language:</strong>
  <%= @movie.language %>
</p>

<p>
  <strong>Subtitles:</strong>
  <%= @movie.subtitles %>
</p>

<p>
  <strong>Dubbed:</strong>
  <%= @movie.dubbed %>
</p>

<p>
  <strong>Country:</strong>
  <%= @movie.country %>
</p>

<p>
  <strong>Age rating:</strong>
  <%= @movie.age_rating %>
</p>

<% @genres = Topic.joins(:movie_topics).where(movie_topics: { movie_id: @movie.id }) %>

<% @genres.each do |genre| %>
  <%= genre.genre_name %>
<% end %>

<br>
<br>


<h2>Watched By</h2>

<% @watches =  MovieRating.select("avg(user_rating) as avg, count(id) as count, profile_id").group("profile_id").order(count: :desc).where movie_id: @movie.id %>

<table>
  <thead>
    <tr>
      <th>User</th>
      <th>Average<br>Rating</th>
      <th>Times Seen</th>
      <th>Reviews</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody style="border: 1px solid black">
    <% @watches.each do |watch| %>
      <% @profile = Profile.find_by id: watch.profile_id %>
      <% @user = User.find_by id: @profile.user_id %>
      <% @userreviews = MovieRating.where(movie_id: @movie.id, profile_id: @profile.id) %>
      <tr>
        <td style="text-align: center"><a href="/users/<%= @user.id %>"><%= @user.email %></a></td>
        <td style="text-align: center"><%= watch.avg %></td>
        <td style="text-align: center"><%= watch.count %></td>
        <td>
          <% @userreviews.each do |userreview| %>
            <% if userreview.review != '' %>
              <%= userreview.review %><br>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<% if current_user.user_type_id == UserType.find_by(type_name: 'Admin').id  %>
  <%= link_to 'Edit', edit_movie_path(@movie) %> | 
<% end %>

<%= link_to 'Back', movies_path %>
